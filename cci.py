import pandas as pd
import numpy as np

def commodity_channel_indicator(ohlc, period = 20):
    typical_price = (ohlc.H + ohlc.L + ohlc.C)/3
    typical_price_ma = pd.rolling_mean(typical_price, period)
    mad = lambda x: np.fabs(x - x.mean()).mean()
    mean_dev = pd.rolling_apply(typical_price, period, mad)
    return (typical_price - typical_price_ma)/(0.015*mean_dev)

if __name__ == "__main__":
    RIY = ['DDD','MMM','AAN','ABT','ABBV','ANF','ACN','ACE','ACT','ATVI','ADBE','ADT','AAP','AMD','ACM','AES','AET','AMG','AFL','AGCO','A','GAS','AL','APD','ARG','AKAM','ALK','ALB','AA','ALR','ARE','ALXN','ALKS','Y','ATI','ALLE','AGN','ADS','LNT','ATK','AWH','ALSN','MDRX','ALL','ALTR','MO','AMZN','AMCX','DOX','UHAL','AEE','AAL','ACC','AGNC','ACAS','AEO','AEP','AXP','AFG','AMH','AIG','ANAT','AMT','AWK','AMP','ABC','AME','AMGN','APH','APC','ADI','NLY','ANSS','AR','AOS','AOL','AON','APA','AIV','APOL','AAPL','AMAT','ATR','WTR','ACGL','ADM','ARCC','ARIA','AWI','ARW','AJG','APAM','ASNA','ASH','AHL','ASBC','AIZ','AGO','T','ATML','ATO','ATW','ADSK','ADP','AN','AZO','AVGO','AVB','AVY','CAR','AVT','AVP','AVX','AXS','BEAV','BWC','BHI','BLL','BYI','BAC','BOH','BK','BKU','BAX','BBT','BDX','BBBY','BMS','BBY','BIG','BIO','BIIB','BMRN','BMR','BLK','BA','BOKF','BAH','BWA','BXP','BSX','BDN','EAT','BMY','BRX','BRCM','BR','BRCD','BKD','BRO','BRKR','BG','BKW','CA','CAB','CVC','CBT','COG','CDNS','CPN','CPT','CAM','CPB','COF','CSE','CAH','CFN','CSL','KMX','CCL','CRS','CRI','CTRX','CAT','CBL','CBOE','CBG','CBS','CDW','CE','CELG','CNP','CTL','CERN','CF','CHRW','CRL','SCHW','CHTR','LNG','CHK','CVX','CBI','CHS','CIM','CMG','CHH','CB','CHD','CI','XEC','CINF','CNK','CTAS','CSCO','CIT','C','CTXS','CYN','CLH','CCO','CLF','CLX','CME','CMS','CNA','COH','CIE','KO','CCE','CTSH','CFX','CL','CMCSA','CMA','CBSH','CWH','COMM','CYH','CMP','CSC','CPWR','CNW','CAG','CXO','CNQR','COP','CNX','ED','STZ','CLR','COO','CPA','CPRT','CLGX','GLW','OFC','CXW','COST','COTY','CVD','CVA','COV','BCR','CR','CREE','CCI','CCK','CST','CSX','CBST','CFR','CMI','CVI','CVS','CYT','DHR','DRI','DVA','DDR','DF','DECK','DE','DLPH','DAL','DNR','XRAY','DVN','DV','DO','DKS','DBD','DLR','DDS','DTV','DFS','DISCA','DISH','DLB','DG','DLTR','D','DPZ','UFS','DCI','DEI','DOV','DOW','DHI','DPS','DWA','DRC','DRQ','DST','DSW','DTE','DUK','DRE','DNB','DNKN','ETFC','EXP','EWBC','EMN','ETN','EV','EBAY','SATS','ECL','EIX','EW','DD','EA','LLY','EMC','EMR','ENDP','ENH','EGN','ENR','ETR','EVHC','EOG','EQT','EFX','EQIX','ELS','EQR','ERIE','ESS','EL','RE','XLS','EXC','EXPE','EXPD','ESRX','EXR','XOM','FFIV','FB','FDS','FCS','FDO','FAST','FRT','FII','FDX','FNF','FIS','FITB','FEYE','FCNCA','FHN','FNFG','FRC','FSLR','FE','FISV','FLT','FLIR','FLO','FLS','FLR','FMC','FTI','FL','F','FRX','FTNT','FBHS','FOSL','FI','BEN','FCX','FSL','TFM','FTR','FULT','GME','GLPI','GCI','GPS','GRMN','IT','GMT','GD','GE','GGP','GIS','GM','GWR','G','GNTX','GPC','GNW','GILD','GPN','GNC','GLNG','GS','GT','GOOG','GGG','GHC','GXP','GEF','GRPN','GES','GPOR','HRB','HAL','HBI','THG','HOG','HAR','HRS','HSC','HIG','HAS','HTS','HE','HCA','HCC','HCP','HDS','HCN','HNT','HTA','HP','HSIC','HLF','HSY','HTZ','HES','HPQ','HXL','HRC','HSH','HFC','HOLX','HD','HME','AWAY','HON','HRL','HSP','HPT','HST','HHC','HCBK','HUM','HBAN','HII','HUN','H','IACI','IEX','IDXX','IHS','ITW','ILMN','INCY','INFA','VOYA','IR','IM','INGR','TEG','INTC','I','IBKR','ICE','IBM','IFF','IGT','IP','IPG','INTU','ISRG','IVZ','IPGP','IRM','ITC','ITT','JBL','JKHY','JEC','JAH','JAZZ','JBHT','JCP','JDSU','SJM','JNJ','JCI','JLL','JOY','JPM','JNPR','KSU','KAR','KBR','K','KMPR','KMT','GMCR','KEY','KRC','KMB','KIM','KMI','KEX','KLAC','KN','KSS','KOS','KRFT','KR','KRO','LB','LLL','LH','LRCX','LAMR','LSTR','LPI','LVS','LAZ','LEA','LM','LEG','LDOS','LEN','LII','LUK','LVLT','LXK','LBTYK','LBTYA','LINTA','LMCA','LPT','LVNTA','LPNT','LECO','LNC','LLTC','LNKD','LGF','LKQ','LMT','L','LO','LOW','LPLA','LYB','MTB','MAC','CLI','M','MSG','MNK','MTW','MAN','MRO','MPC','MKL','MAR','MMC','MLM','MRVL','MAS','MA','MAT','MXIM','MBI','MKC','MDR','MCD','MHFI','MCK','MDU','MJN','MWV','MDVN','MD','MDT','MRK','MCY','MET','MTD','MFA','MGM','KORS','MCHP','MU','MCRS','MSFT','MAA','MHK','TAP','MDLZ','MON','MNST','MCO','MS','MORN','MOS','MSI','MRC','MSM','MSCI','MUR','MUSA','MYL','MYGN','NBR','NDAQ','NFG','NATI','NOV','NNN','NSM','NAV','NCR','NTAP','NFLX','N','NSR','NYCB','NWL','NFX','NEU','NEM','NWSA','NEE','NLSN','NKE','NI','NBL','NDSN','JWN','NSC','NU','NTRS','NOC','NCLH','NRG','NUS','NUAN','NUE','NVDA','NVR','ORLY','OAS','OXY','OII','OCN','OGE','OIS','ODFL','ORI','OHI','OCR','OMC','ONNN','OGS','OKE','ORCL','OSK','OC','OI','PCAR','PKG','PLL','PANW','P','PNRA','PH','PRE','PDCO','PTEN','PAYX','PBF','BTU','PENN','PNR','PBCT','POM','PEP','PKI','PRGO','PETM','PFE','PCG','PCYC','PM','PSX','PDM','PF','PNW','PXD','PBI','PCL','PNC','PII','PLCM','BPOP','PPS','PPG','PPL','PX','PCP','PINC','PCLN','PFG','PRA','PG','PGR','PLD','PL','PRU','PEG','PSA','PHM','PVH','QEP','QGEN','QCOM','PWR','DGX','STR','Q','RAX','RL','RRC','RJF','RYN','RTN','RLGY','O','RHT','RGC','RBC','REG','REGN','RF','RGA','RS','RNR','RSG','RMD','RPAI','RAI','RVBD','RHI','RKT','ROK','COL','ROC','ROL','ROP','ROST','ROVI','RDC','RCL','RGLD','RES','RPM','RRD','R','SWY','CRM','SLXP','SBH','SNDK','SD','SBAC','SCG','SLB','SAIC','SMG','SNI','SDRL','SEE','SHLD','SGEN','SEAS','SEIC','SRE','SNH','SCI','NOW','SHW','SIAL','SBNY','SIG','SLGN','SLAB','SPG','SIRI','SIRO','SIX','SWKS','SLG','SLM','SM','SNA','SCTY','SWI','SLH','SON','SO','SCCO','LUV','SWN','SE','SPR','SRC','SPLK','S','SFM','SPW','JOE','STJ','SFG','SWK','SPLS','SBUX','HOT','STWD','SWAY','STRZA','STT','STLD','SRCL','SSYS','SYK','STI','SPN','SIVB','SYMC','SNPS','SNV','SYY','TROW','TMUS','DATA','TAHO','SKT','TGT','TCO','TMHC','TCB','AMTD','TECD','TECH','TE','TK','TFX','TDS','TPX','THC','TDC','TER','TEX','TSLA','TSO','TXN','TXT','TFSL','THRX','TMO','TRI','THO','TIBX','TDW','TIF','TWC','TWX','TKR','TJX','TOL','TMK','TTC','TSS','TW','TSCO','TDG','TRV','TRMB','TRN','TRIP','TGI','TRW','TUP','TWTC','FOXA','TWTR','TWO','TSN','UDR','UGI','ULTA','UPL','UA','UNP','UNT','UAL','UPS','URI','USM','X','UTX','UTHR','UNH','UHS','UNM','URBN','URS','USB','VLO','VR','VLY','VMI','VAL','VNTV','VAR','WOOF','VVC','VEEV','VTR','PAY','VRSN','VRSK','VZ','VRTX','VFC','VIAB','V','VSH','VC','VMW','VNO','VMC','WBC','WAB','WDR','WMT','WAG','DIS','WAFD','WCN','WM','WAT','WTW','WRI','WLP','WFC','WEN','WCC','WR','WDC','WU','WLK','WY','WHR','WTM','WWAV','WLL','WFM','WMB','WSM','WIN','WEC','WDAY','INT','WPC','WPX','WRB','GRA','GWW','WYN','WYNN','XEL','XRX','XLNX','XL','XYL','YHOO','YUM','ZBRA','ZMH','ZION','ZTS','ZU','ZNGA']
    for s in RIY:
        ohlc = pd.read_hdf('Data/'+s+'.h5', s)
        cci[s] = commodity_channel_indicator(ohlc)
        ret[s] = np.log(ohlc.C/ohlc.C.shift())
    wt = cci - cci.mean(axis=1)
    wt = wt/np.abs(wt).sum(axis=1)
    equity = np.exp((wt.shift()*ret).sum(axis=1).cumsum())
    equity.plot(label='PORTFOLIO')
